<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Security PDF Locker</title>
    
    <!-- PDF-Lib Library -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- FileSaver for Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --bg: #f8fafc;
            --white: #ffffff;
        }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .box { background: var(--white); padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        .upload-box { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; margin-bottom: 15px; }
        .upload-box:hover { background: #eff6ff; border-color: var(--primary); }
        input[type="file"] { display: none; }
        input[type="password"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 5px; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background: #4f46e5; }
        button:disabled { background: #94a3b8; }
        .status { margin-top: 15px; text-align: center; font-size: 14px; min-height: 20px; }
        .error { color: red; }
        .success { color: green; }
        .tab-group { display: flex; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .tab { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; font-weight: bold; color: #64748b; }
        .tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); }
    </style>
</head>
<body>

<div class="box">
    <h2>PDF Tool</h2>
    
    <div class="tab-group">
        <button class="tab active" onclick="setMode('lock')" id="t-lock">Lock PDF</button>
        <button class="tab" onclick="setMode('unlock')" id="t-unlock">Unlock PDF</button>
    </div>

    <div class="upload-box" onclick="document.getElementById('fileIn').click()">
        <p id="fileName">ðŸ“‚ Click to Select PDF</p>
        <input type="file" id="fileIn" accept="application/pdf">
    </div>

    <input type="password" id="passIn" placeholder="Enter Password">
    
    <button id="btnAction" onclick="processPDF()">ðŸ”’ Lock PDF</button>
    <p class="status" id="status"></p>
</div>

<script>
    let mode = 'lock';
    let fileBytes = null;
    let fName = "document.pdf";

    const fileIn = document.getElementById('fileIn');
    const status = document.getElementById('status');
    const btn = document.getElementById('btnAction');

    function setMode(m) {
        mode = m;
        document.getElementById('t-lock').className = m === 'lock' ? 'tab active' : 'tab';
        document.getElementById('t-unlock').className = m === 'unlock' ? 'tab active' : 'tab';
        btn.innerText = m === 'lock' ? "ðŸ”’ Lock PDF" : "ðŸ”“ Unlock PDF";
        document.getElementById('passIn').placeholder = m === 'lock' ? "Set New Password" : "Enter Original Password";
        status.innerText = "";
    }

    fileIn.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(file && file.type === "application/pdf") {
            fName = file.name;
            document.getElementById('fileName').innerText = "âœ… " + file.name;
            const reader = new FileReader();
            reader.onload = (ev) => fileBytes = ev.target.result;
            reader.readAsArrayBuffer(file);
        } else {
            alert("Please select a PDF file.");
        }
    });

    async function processPDF() {
        if(!fileBytes) return status.innerText = "Please select a file first!";
        const password = document.getElementById('passIn').value;
        if(!password) return status.innerText = "Please enter a password!";

        btn.disabled = true;
        btn.innerText = "Processing...";
        status.innerText = "Working...";
        status.className = "status";

        try {
            const { PDFDocument } = PDFLib;

            if(mode === 'lock') {
                // --- STRONG LOCK METHOD ---
                // 1. Load Original
                const originalPdf = await PDFDocument.load(fileBytes);
                
                // 2. Create New
                const newPdf = await PDFDocument.create();
                
                // 3. Copy Pages
                const indices = originalPdf.getPageIndices();
                const pages = await newPdf.copyPages(originalPdf, indices);
                pages.forEach(p => newPdf.addPage(p));

                // 4. Encrypt & Save
                const pdfData = await newPdf.save({
                    userPassword: password,
                    ownerPassword: password,
                    permissions: {
                        printing: 'highResolution',
                        modifying: false,
                        copying: false
                    }
                });
                download(pdfData, "Locked_" + fName);
                status.innerText = "Success! File Downloaded.";
                status.className = "status success";

            } else {
                // --- UNLOCK METHOD ---
                try {
                    const pdfDoc = await PDFDocument.load(fileBytes, { password: password });
                    const pdfData = await pdfDoc.save(); // Save without password
                    download(pdfData, "Unlocked_" + fName);
                    status.innerText = "Success! Unlocked File Downloaded.";
                    status.className = "status success";
                } catch(e) {
                    throw new Error("Wrong Password or File not locked.");
                }
            }
        } catch(err) {
            console.error(err);
            status.innerText = "Error: " + err.message;
            status.className = "status error";
        }

        btn.disabled = false;
        btn.innerText = mode === 'lock' ? "ðŸ”’ Lock PDF" : "ðŸ”“ Unlock PDF";
    }

    function download(data, name) {
        const blob = new Blob([data], { type: 'application/pdf' });
        saveAs(blob, name);
    }
</script>

</body>
</html>
