<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional E-Sign PDF</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563EB;
            --primary-hover: #1d4ed8;
            --surface: #FFFFFF;
            --background: #F8FAFC;
            --text-main: #0F172A;
            --text-light: #64748B;
            --border: #E2E8F0;
            --radius: 12px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }

        body {
            background-color: var(--background);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container { width: 100%; max-width: 1200px; display: flex; flex-direction: column; gap: 20px; }
        header { text-align: center; margin-bottom: 1rem; }
        header h1 { color: var(--primary); font-size: 2rem; margin-bottom: 0.5rem; }

        /* 1. Upload Card */
        .upload-card {
            background: var(--surface);
            border: 2px dashed var(--primary);
            border-radius: var(--radius);
            padding: 4rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
            box-shadow: var(--shadow);
        }
        .upload-card:hover { background-color: #EFF6FF; }
        .upload-icon { font-size: 3.5rem; color: var(--primary); margin-bottom: 1.5rem; }
        .upload-btn {
            background: var(--primary); color: white; padding: 12px 24px;
            border-radius: 50px; border: none; font-weight: 600; margin-top: 1rem;
        }
        input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* Generic Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 2000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; border-radius: 8px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            animation: fadeIn 0.3s ease-out;
            width: 95%; max-width: 800px;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* 2. "Who is signing" Modal */
        #selection-modal .modal-content { padding: 2.5rem; max-width: 900px; }
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 1.5rem; }
        .choice-card {
            border-radius: 8px; padding: 40px 20px; display: flex; flex-direction: column;
            align-items: center; text-align: center; border: 1px solid transparent; cursor: pointer; transition: 0.2s;
        }
        .card-myself { background-color: #F0F9FF; }
        .card-myself:hover { border-color: var(--primary); }
        .card-others { background-color: #F0FDF4; }
        .illustration i { font-size: 5rem; margin-bottom: 20px; opacity: 0.9; }
        .modal-btn {
            background: var(--primary); color: white; border: none; padding: 12px 24px;
            border-radius: 4px; font-weight: 600; cursor: pointer; margin-bottom: 10px;
        }
        .modal-btn:hover { background: var(--primary-hover); }

        /* 3. "Set signature details" Modal */
        #signature-creation-modal .modal-content { padding: 0; overflow: hidden; max-width: 700px; }
        .sig-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sig-header h2 { font-size: 1.25rem; margin: 0; }
        
        .sig-body { padding: 20px; }
        
        /* Input Row */
        .input-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .input-group { flex: 1; }
        .input-group label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; color: var(--text-main); }
        .input-group input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; }

        /* Tabs */
        .sig-tabs { display: flex; border-bottom: 2px solid var(--border); gap: 20px; }
        .sig-tab { 
            padding: 10px 10px; cursor: pointer; font-weight: 600; color: var(--text-light); 
            border-bottom: 2px solid transparent; margin-bottom: -2px; display: flex; align-items: center; gap: 8px;
        }
        .sig-tab:hover { color: var(--primary); }
        .sig-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* Creation Area */
        .creation-container { display: flex; border: 1px solid var(--border); border-top: none; height: 300px; background: #F8FAFC; }
        
        /* Sidebar */
        .creation-sidebar { 
            width: 60px; background: white; border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; align-items: center; padding-top: 10px; gap: 10px;
        }
        .side-tool { 
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; 
            border-radius: 6px; cursor: pointer; color: var(--text-light); font-size: 1.2rem;
        }
        .side-tool:hover { background: #EFF6FF; color: var(--primary); }
        .side-tool.active { background: #DBEAFE; color: var(--primary); }

        /* Stage */
        .creation-stage { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; padding: 20px; }
        
        .stage-content { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .stage-content.active { display: flex; }

        /* Draw Mode */
        canvas#modal-sig-pad { width: 100%; height: 100%; background: white; border: 1px dashed #CBD5E1; cursor: crosshair; }
        .clear-sig { position: absolute; top: 10px; right: 10px; font-size: 0.8rem; color: var(--primary); cursor: pointer; background: white; padding: 2px 5px; }

        /* Type Mode */
        #signature-text-input { 
            width: 80%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 20px; font-size: 1rem; 
        }
        .type-preview-box { 
            height: 120px; display: flex; align-items: center; justify-content: center; 
            border: 1px dashed var(--border); width: 80%; background: white; 
        }

        /* Upload Mode */
        .upload-placeholder { 
            border: 2px dashed var(--border); width: 80%; height: 80%; background: white; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; 
        }
        .upload-btn-small { 
            border: 1px solid var(--primary); color: var(--primary); background: white; 
            padding: 8px 16px; border-radius: 4px; font-weight: 600; cursor: pointer; 
        }

        .sig-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; background: #F8FAFC; }

        /* 4. Workspace */
        .workspace { display: none; flex-direction: column; gap: 20px; }
        @media (min-width: 992px) { .workspace { flex-direction: row; align-items: flex-start; } }

        .pdf-wrapper {
            flex: 2; background: #E2E8F0; border-radius: var(--radius); padding: 20px;
            display: flex; flex-direction: column; align-items: center; 
            overflow: auto; max-height: 85vh; border: 1px solid var(--border);
        }
        .canvas-box { position: relative; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        canvas#pdf-render { display: block; max-width: 100%; height: auto; }

        .drag-sig {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border: 2px dashed var(--primary); background: rgba(37, 99, 235, 0.1);
            cursor: grab; z-index: 100;
        }
        .drag-sig img { width: 100%; height: 100%; display: block; pointer-events: none; }
        .delete-btn {
            position: absolute; top: -12px; right: -12px;
            background: #EF4444; color: white; border-radius: 50%; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px;
        }

        .toolbar {
            flex: 1; background: var(--surface); padding: 25px; border-radius: var(--radius);
            box-shadow: var(--shadow); position: sticky; top: 20px;
            display: flex; flex-direction: column; gap: 20px;
        }

        @media (max-width: 768px) {
            .choice-grid { grid-template-columns: 1fr; }
            .input-row { flex-direction: column; gap: 10px; }
            .creation-container { height: auto; flex-direction: column; }
            .creation-sidebar { width: 100%; flex-direction: row; border-right: none; border-bottom: 1px solid var(--border); padding: 10px; justify-content: center; }
            .creation-stage { min-height: 200px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Professional E-Sign</h1>
    </header>

    <!-- 1. Upload Section -->
    <div class="upload-card" id="upload-section">
        <i class="fa-regular fa-file-pdf upload-icon"></i>
        <h2>Upload Document</h2>
        <p style="color: #64748B; margin-bottom: 20px;">Drag & drop your PDF here or browse</p>
        <button class="upload-btn">Choose File</button>
        <input type="file" id="file-input" accept="application/pdf">
    </div>

    <!-- 2. "Who's Signing" Modal -->
    <div class="modal-overlay" id="selection-modal">
        <div class="modal-content">
            <h2 style="font-size: 1.5rem; font-weight: 700;">Choose who’s signing</h2>
            <div class="choice-grid">
                <div class="choice-card card-myself" onclick="openSignatureCreation()">
                    <div class="illustration"><i class="fa-solid fa-file-signature" style="color: #60A5FA;"></i></div>
                    <button class="modal-btn"><i class="fa-regular fa-user"></i> Sign myself</button>
                    <p>Create a signature and sign a document.</p>
                </div>
                <div class="choice-card card-others" style="opacity: 0.6; cursor: default;">
                    <div class="illustration"><i class="fa-solid fa-users-viewfinder" style="color: #4ADE80;"></i></div>
                    <button class="modal-btn" style="background:#94A3B8; cursor:not-allowed;"><i class="fa-solid fa-user-group"></i> Get signatures</button>
                    <p>Invite others to sign (Server required).</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. "Set Signature Details" Modal -->
    <div class="modal-overlay" id="signature-creation-modal">
        <div class="modal-content">
            <div class="sig-header">
                <h2>Set your signature details</h2>
            </div>
            
            <div class="sig-body">
                <div class="input-row">
                    <div class="input-group">
                        <label>Full name:</label>
                        <input type="text" id="signer-name" placeholder="Your name">
                    </div>
                    <div class="input-group">
                        <label>Initials:</label>
                        <input type="text" id="signer-initials" placeholder="Your initials">
                    </div>
                </div>

                <!-- CATEGORY TABS -->
                <div class="sig-tabs">
                    <div class="sig-tab active" onclick="switchCategory(this, 'signature')">
                        <i class="fa-solid fa-pen-nib"></i> Signature
                    </div>
                    <div class="sig-tab" onclick="switchCategory(this, 'initials')">
                        AC Initials
                    </div>
                    <div class="sig-tab" onclick="switchCategory(this, 'stamp')">
                        <i class="fa-solid fa-stamp"></i> Company Stamp
                    </div>
                </div>

                <div class="creation-container">
                    <!-- Sidebar Icons -->
                    <div class="creation-sidebar">
                        <div class="side-tool active" onclick="setMode('type')"><i class="fa-solid fa-font"></i></div>
                        <div class="side-tool" onclick="setMode('draw')"><i class="fa-solid fa-pen-nib"></i></div>
                        <div class="side-tool" onclick="setMode('upload')"><i class="fa-solid fa-arrow-up-from-bracket"></i></div>
                    </div>

                    <!-- Content Area -->
                    <div class="creation-stage">
                        
                        <!-- Type Mode -->
                        <div id="mode-type" class="stage-content active">
                            <input type="text" id="signature-text-input" placeholder="Type signature..." oninput="previewTypeSignature()">
                            <div class="type-preview-box">
                                <img id="signature-type-preview" style="max-height: 80%; display:none;">
                                <span id="type-placeholder" style="color:#CBD5E1;">Preview</span>
                            </div>
                        </div>

                        <!-- Draw Mode -->
                        <div id="mode-draw" class="stage-content">
                            <canvas id="modal-sig-pad"></canvas>
                            <span class="clear-sig" onclick="clearModalPad()">Clear</span>
                        </div>

                        <!-- Upload Mode -->
                        <div id="mode-upload" class="stage-content">
                            <div class="upload-placeholder" onclick="document.getElementById('sig-upload-input').click()" style="cursor:pointer;">
                                <button class="upload-btn-small">Upload Image</button>
                                <p id="upload-text-hint" style="font-size:0.9rem; color:#64748B;">or drop file here</p>
                                <small style="color:#94A3B8;">PNG, JPG, SVG</small>
                                <input type="file" id="sig-upload-input" hidden accept="image/*" onchange="handleSigUpload(this)">
                            </div>
                            <img id="upload-preview-img" style="display:none; max-height:150px; margin-top:10px;">
                        </div>

                    </div>
                </div>
            </div>

            <div class="sig-footer">
                <button class="modal-btn" style="margin:0;" onclick="applySignature()">Apply</button>
            </div>
        </div>
    </div>

    <!-- 4. Workspace -->
    <div class="workspace" id="workspace">
        <div class="pdf-wrapper">
            <div class="canvas-box" id="canvas-box">
                <canvas id="pdf-render"></canvas>
            </div>
        </div>

        <div class="toolbar">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <button id="prev-page" style="background:none; border:none; cursor:pointer;"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="page-info">Page 1</span>
                <button id="next-page" style="background:none; border:none; cursor:pointer;"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <hr style="border:0; border-top:1px solid #E2E8F0;">
            
            <p style="text-align:center; color:#64748B; font-size:0.9rem;">
                Your item is ready. Click "Add" to place another copy.
            </p>

            <button class="modal-btn" style="width:100%; justify-content:center;" onclick="placeStoredSignature()">
                <i class="fa-solid fa-plus"></i> Add to Page
            </button>
            
            <button class="modal-btn" style="width:100%; justify-content:center; background:#EF4444;" onclick="openSignatureCreation()">
                <i class="fa-solid fa-pen"></i> Create New
            </button>

            <div style="margin-top: auto;">
                <button class="modal-btn" style="width:100%; justify-content:center; background:#10B981;" id="download-btn" onclick="downloadPDF()">
                    <i class="fa-solid fa-download"></i> Download PDF
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Global State ---
    let pdfDoc = null, pdfBytes = null, pageNum = 1, pdfScale = 1.5;
    let activeSignature = null;
    let storedSignatureImg = null; 
    let currentCategory = 'signature'; // signature, initials, stamp
    const canvas = document.getElementById('pdf-render');
    const ctx = canvas.getContext('2d');

    // --- Modal Logic Vars ---
    let currentMode = 'type';
    const modalPad = document.getElementById('modal-sig-pad');
    const modalCtx = modalPad.getContext('2d');
    let modalDrawing = false;

    // --- 1. File Upload ---
    document.getElementById('file-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file && file.type === 'application/pdf') {
            pdfBytes = await file.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument(pdfBytes).promise;
            
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('selection-modal').style.display = 'flex';
        }
    });

    // --- 2. Open Signature Creation ---
    function openSignatureCreation() {
        document.getElementById('selection-modal').style.display = 'none';
        document.getElementById('workspace').style.display = 'none'; 
        document.getElementById('signature-creation-modal').style.display = 'flex';
        
        setTimeout(() => {
            modalPad.width = modalPad.offsetWidth;
            modalPad.height = modalPad.offsetHeight;
            modalCtx.lineWidth = 2; modalCtx.lineCap = 'round';
        }, 100);
    }

    // --- 3. Category Switching (Signature vs Stamp) ---
    function switchCategory(el, type) {
        currentCategory = type;
        
        // UI Active State
        document.querySelectorAll('.sig-tab').forEach(tab => tab.classList.remove('active'));
        el.classList.add('active');

        // Contextual UI Updates
        const textInput = document.getElementById('signature-text-input');
        const uploadBtn = document.querySelector('.upload-btn-small');
        
        if (type === 'stamp') {
            textInput.placeholder = "Company Name";
            uploadBtn.textContent = "Upload Stamp";
            // Set font to bold simple font for preview
        } else if (type === 'initials') {
            textInput.placeholder = "Initials";
            uploadBtn.textContent = "Upload Initials";
        } else {
            textInput.placeholder = "Type signature...";
            uploadBtn.textContent = "Upload Signature";
        }
        
        // Re-trigger preview to update font style
        previewTypeSignature();
    }

    // --- 4. Modal Mode Switching ---
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.side-tool').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.querySelectorAll('.stage-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`mode-${mode}`).classList.add('active');
    }

    // --- 5. Type Logic ---
    function previewTypeSignature() {
        const val = document.getElementById('signature-text-input').value;
        const img = document.getElementById('signature-type-preview');
        const ph = document.getElementById('type-placeholder');
        
        if(!val) { img.style.display='none'; ph.style.display='block'; return; }
        
        const c = document.createElement('canvas'); const cx = c.getContext('2d');
        c.width = 400; c.height = 100;

        if (currentCategory === 'stamp') {
             // Stamp Style
             cx.font = "bold 40px 'Courier New', monospace";
             cx.fillStyle = "#000"; cx.textBaseline = "middle"; 
             // Draw box
             cx.strokeStyle = "#000"; cx.lineWidth = 4;
             cx.strokeRect(10, 10, 380, 80);
             cx.fillText(val, 30, 50);
        } else {
             // Cursive Style
             cx.font = "40px 'Brush Script MT', cursive"; 
             cx.fillStyle = "#000"; cx.textBaseline = "middle"; 
             cx.fillText(val, 20, 50);
        }
        
        img.src = c.toDataURL();
        img.style.display = 'block'; ph.style.display='none';
    }

    // --- 6. Draw Logic ---
    function getModalPos(e) {
        const rect = modalPad.getBoundingClientRect();
        const x = e.touches ? e.touches[0].clientX : e.clientX;
        const y = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: x - rect.left, y: y - rect.top };
    }
    ['mousedown', 'touchstart'].forEach(ev => modalPad.addEventListener(ev, (e) => {
        if(e.cancelable) e.preventDefault(); modalDrawing = true;
        const p = getModalPos(e); modalCtx.beginPath(); modalCtx.moveTo(p.x, p.y);
    }));
    ['mousemove', 'touchmove'].forEach(ev => modalPad.addEventListener(ev, (e) => {
        if(e.cancelable) e.preventDefault(); if(!modalDrawing) return;
        const p = getModalPos(e); modalCtx.lineTo(p.x, p.y); modalCtx.stroke();
    }));
    ['mouseup', 'touchend'].forEach(ev => modalPad.addEventListener(ev, () => modalDrawing = false));
    function clearModalPad() { modalCtx.clearRect(0, 0, modalPad.width, modalPad.height); }

    // --- 7. Upload Logic ---
    function handleSigUpload(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.querySelector('.upload-placeholder').style.display = 'none';
                const img = document.getElementById('upload-preview-img');
                img.src = e.target.result;
                img.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- 8. Apply & Workspace ---
    function applySignature() {
        let finalSrc = null;

        if (currentMode === 'type') {
            const img = document.getElementById('signature-type-preview');
            if (img.style.display !== 'none') finalSrc = img.src;
        } else if (currentMode === 'draw') {
            const data = modalCtx.getImageData(0,0,modalPad.width,modalPad.height).data;
            if(data.some(c => c !== 0)) finalSrc = modalPad.toDataURL();
        } else if (currentMode === 'upload') {
            const img = document.getElementById('upload-preview-img');
            if (img.style.display !== 'none') finalSrc = img.src;
        }

        if (!finalSrc) return alert("Please create or upload a signature/stamp first.");

        storedSignatureImg = finalSrc;
        document.getElementById('signature-creation-modal').style.display = 'none';
        document.getElementById('workspace').style.display = 'flex';
        renderPage(pageNum);
        setTimeout(placeStoredSignature, 500);
    }

    async function renderPage(num) {
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale: pdfScale });
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
        document.getElementById('page-info').innerText = `Page ${num}`;
        if(activeSignature) { activeSignature.remove(); activeSignature = null; }
    }
    
    document.getElementById('prev-page').onclick = () => { if(pageNum > 1) { pageNum--; renderPage(pageNum); }};
    document.getElementById('next-page').onclick = () => { if(pageNum < pdfDoc.numPages) { pageNum++; renderPage(pageNum); }};

    function placeStoredSignature() {
        if (!storedSignatureImg) return;
        if (activeSignature) activeSignature.remove();

        const el = document.createElement('div');
        el.className = 'drag-sig';
        el.style.width = '150px'; el.style.height = 'auto';
        el.innerHTML = `<img src="${storedSignatureImg}"><div class="delete-btn" onclick="this.parentElement.remove(); activeSignature=null;">×</div>`;
        document.getElementById('canvas-box').appendChild(el);
        activeSignature = el;
        makeDraggable(el);
    }

    function makeDraggable(el) {
        let pos1=0, pos2=0, pos3=0, pos4=0;
        el.onmousedown = dragMouseDown; el.ontouchstart = dragMouseDown;
        function dragMouseDown(e) {
            pos3 = e.clientX || e.touches[0].clientX; pos4 = e.clientY || e.touches[0].clientY;
            document.onmouseup = closeDrag; document.onmousemove = elementDrag;
            document.ontouchend = closeDrag; document.ontouchmove = elementDrag;
        }
        function elementDrag(e) {
            const cx = e.clientX || e.touches[0].clientX; const cy = e.clientY || e.touches[0].clientY;
            pos1 = pos3 - cx; pos2 = pos4 - cy; pos3 = cx; pos4 = cy;
            let t = el.offsetTop - pos2; let l = el.offsetLeft - pos1;
            const p = el.parentElement;
            if(t < 0) t = 0; if(l < 0) l = 0;
            if(t + el.offsetHeight > p.offsetHeight) t = p.offsetHeight - el.offsetHeight;
            if(l + el.offsetWidth > p.offsetWidth) l = p.offsetWidth - el.offsetWidth;
            el.style.top = t + "px"; el.style.left = l + "px";
        }
        function closeDrag() { document.onmouseup = null; document.onmousemove = null; document.ontouchend = null; document.ontouchmove = null; }
    }

    async function downloadPDF() {
        if(!activeSignature) return alert("Place item first");
        const btn = document.getElementById('download-btn');
        btn.innerHTML = "Processing..."; btn.disabled = true;
        try {
            const { PDFDocument } = PDFLib; const pdf = await PDFDocument.load(pdfBytes);
            const page = pdf.getPage(pageNum - 1);
            const imgEl = activeSignature.querySelector('img');
            const png = await pdf.embedPng(imgEl.src);
            const { width: pW, height: pH } = page.getSize();
            const rect = activeSignature.getBoundingClientRect();
            const box = document.getElementById('canvas-box').getBoundingClientRect();
            const scaleX = pW / canvas.width; const scaleY = pH / canvas.height;
            const x = (rect.left - box.left) * scaleX;
            const y = pH - ((rect.top - box.top) * scaleY) - (activeSignature.offsetHeight * scaleY);
            page.drawImage(png, { x, y, width: activeSignature.offsetWidth * scaleX, height: activeSignature.offsetHeight * scaleY });
            const saved = await pdf.save();
            saveAs(new Blob([saved], { type: 'application/pdf' }), 'signed_doc.pdf');
        } catch(e) { console.error(e); alert("Error"); }
        finally { btn.innerHTML = '<i class="fa-solid fa-download"></i> Download PDF'; btn.disabled = false; }
    }
</script>

</body>
</html>
