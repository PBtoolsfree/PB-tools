<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro PDF Signer Suite</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- 3. Core Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        
        body { background-color: #e5e7eb; }

        #canvas-container {
            position: relative;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            background-color: white;
            transition: all 0.2s;
        }

        .drag-element {
            position: absolute;
            user-select: none;
            touch-action: none;
            cursor: move;
            border: 1px dashed transparent; 
        }
        
        .drag-element.active {
            border: 1px dashed #2563eb;
            background: rgba(37, 99, 235, 0.05);
        }

        .resize-handle {
            display: none;
            position: absolute;
            width: 10px;
            height: 10px;
            background: #2563eb;
            border-radius: 50%;
            z-index: 20;
        }
        .drag-element.active .resize-handle { display: block; }
        .handle-se { bottom: -5px; right: -5px; cursor: nwse-resize; }

        .delete-btn {
            display: none;
            position: absolute;
            top: -12px;
            right: -12px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            z-index: 30;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .drag-element.active .delete-btn { display: flex; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 font-sans">

    <!-- Navbar -->
    <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 z-20 shadow-sm">
        <div class="flex items-center gap-2">
            <i class="ph ph-pen-nib text-blue-600 text-2xl"></i>
            <h1 class="font-bold text-xl tracking-tight text-gray-800">ProSign<span class="text-blue-600">Tool</span></h1>
        </div>

        <div class="flex items-center gap-3">
            <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition flex items-center gap-2 text-sm">
                <i class="ph ph-upload-simple"></i> Upload PDF
                <input type="file" id="pdf-upload" accept="application/pdf" class="hidden">
            </label>

            <button id="download-btn" disabled class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-5 py-2 rounded-lg font-medium transition flex items-center gap-2 text-sm shadow-md">
                <i class="ph ph-download-simple"></i> Download Signed
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar Tools -->
        <aside class="w-20 bg-white border-r border-gray-200 flex flex-col items-center py-6 gap-6 z-10 hidden" id="sidebar">
            <button onclick="openSignatureModal()" class="tool-btn group flex flex-col items-center gap-1 text-gray-500 hover:text-blue-600 transition">
                <div class="w-10 h-10 rounded-full bg-gray-50 group-hover:bg-blue-50 flex items-center justify-center">
                    <i class="ph ph-signature text-xl"></i>
                </div>
                <span class="text-xs font-medium">Sign</span>
            </button>

            <label class="tool-btn group flex flex-col items-center gap-1 text-gray-500 hover:text-blue-600 transition cursor-pointer">
                <div class="w-10 h-10 rounded-full bg-gray-50 group-hover:bg-blue-50 flex items-center justify-center">
                    <i class="ph ph-stamp text-xl"></i>
                </div>
                <span class="text-xs font-medium">Stamp</span>
                <input type="file" id="stamp-upload" accept="image/*" class="hidden">
            </label>

            <button onclick="addTextTool()" class="tool-btn group flex flex-col items-center gap-1 text-gray-500 hover:text-blue-600 transition">
                <div class="w-10 h-10 rounded-full bg-gray-50 group-hover:bg-blue-50 flex items-center justify-center">
                    <i class="ph ph-text-t text-xl"></i>
                </div>
                <span class="text-xs font-medium">Text</span>
            </button>

            <button onclick="addDateTool()" class="tool-btn group flex flex-col items-center gap-1 text-gray-500 hover:text-blue-600 transition">
                <div class="w-10 h-10 rounded-full bg-gray-50 group-hover:bg-blue-50 flex items-center justify-center">
                    <i class="ph ph-calendar-plus text-xl"></i>
                </div>
                <span class="text-xs font-medium">Date</span>
            </button>
        </aside>

        <!-- Main Workspace -->
        <main class="flex-1 relative bg-gray-100 overflow-auto flex flex-col items-center p-8" id="workspace">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400">
                <i class="ph ph-file-pdf text-6xl mb-4 text-gray-300"></i>
                <p class="text-lg">Upload a PDF to start signing</p>
            </div>

            <div id="canvas-container" class="hidden">
                <canvas id="pdf-canvas"></canvas>
            </div>

            <div id="pagination" class="fixed bottom-6 bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-lg border border-gray-200 flex items-center gap-4 hidden z-40">
                <button id="prev-page" class="hover:bg-gray-100 p-1 rounded-full"><i class="ph ph-caret-left"></i></button>
                <span id="page-info" class="text-sm font-semibold tabular-nums">Page 1 / 1</span>
                <button id="next-page" class="hover:bg-gray-100 p-1 rounded-full"><i class="ph ph-caret-right"></i></button>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loader" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-white/80 backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-3 font-medium text-gray-600">Processing...</p>
        </div>
    </div>

    <!-- Signature Modal -->
    <div id="sig-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-200" id="sig-modal-content">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg">Add Signature</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <div class="p-4">
                <!-- Tabs -->
                <div class="flex bg-gray-100 p-1 rounded-lg mb-4">
                    <button onclick="switchTab('draw')" id="tab-draw" class="flex-1 py-1 text-sm font-medium rounded-md shadow bg-white text-blue-600 transition-all">Draw</button>
                    <button onclick="switchTab('type')" id="tab-type" class="flex-1 py-1 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700 transition-all">Type</button>
                    <button onclick="switchTab('upload')" id="tab-upload" class="flex-1 py-1 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700 transition-all">Upload</button>
                </div>

                <!-- Draw Area -->
                <div id="area-draw" class="border rounded-lg bg-white relative">
                    <canvas id="pad-canvas" class="w-full h-40 touch-none"></canvas>
                    <p class="absolute bottom-2 left-0 right-0 text-center text-xs text-gray-300 pointer-events-none">Sign Here</p>
                </div>

                <!-- Type Area -->
                <div id="area-type" class="hidden">
                    <input type="text" id="type-input" placeholder="Type your name" class="w-full border rounded-lg p-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                    <div id="type-preview" class="h-28 flex items-center justify-center text-4xl text-gray-800" style="font-family: 'Brush Script MT', cursive;"></div>
                </div>

                <!-- Upload Area (New) -->
                <div id="area-upload" class="hidden">
                    <div class="h-40 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 hover:bg-gray-100 transition relative flex flex-col items-center justify-center overflow-hidden">
                        <input type="file" id="sig-image-upload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        
                        <!-- Placeholder -->
                        <div id="upload-placeholder" class="text-center">
                            <i class="ph ph-upload-simple text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-500 font-medium">Click to Upload Image</p>
                            <p class="text-xs text-gray-400 mt-1">PNG or JPG</p>
                        </div>

                        <!-- Preview -->
                        <img id="upload-preview" src="" class="hidden w-full h-full object-contain p-2 z-0">
                    </div>
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-between">
                <button onclick="clearPad()" class="text-sm text-red-500 font-medium hover:bg-red-50 px-3 py-2 rounded-lg transition">Clear</button>
                <div class="flex gap-2">
                    <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-200 rounded-lg transition">Cancel</button>
                    <button onclick="applySignature()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow transition">Add Signature</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- State ---
    const state = { pdfDoc: null, pageNum: 1, scale: 1.5, pdfBytes: null };
    let signaturePad;
    let activeTab = 'draw';

    // --- DOM Elements ---
    const els = {
        upload: document.getElementById('pdf-upload'),
        container: document.getElementById('canvas-container'),
        canvas: document.getElementById('pdf-canvas'),
        ctx: document.getElementById('pdf-canvas').getContext('2d'),
        loader: document.getElementById('loader'),
        sidebar: document.getElementById('sidebar'),
        empty: document.getElementById('empty-state'),
        pagination: document.getElementById('pagination'),
        pageInfo: document.getElementById('page-info'),
        modal: document.getElementById('sig-modal'),
        modalContent: document.getElementById('sig-modal-content'),
        padCanvas: document.getElementById('pad-canvas'),
        sigUpload: document.getElementById('sig-image-upload'),
        uploadPrev: document.getElementById('upload-preview'),
        uploadPlace: document.getElementById('upload-placeholder')
    };

    // --- Helper: Resize Canvas for Retina Displays ---
    function resizeCanvas(canvas) {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
    }

    // --- 1. PDF Loading ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    els.upload.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        els.loader.classList.remove('hidden');
        
        const reader = new FileReader();
        reader.onload = async (ev) => {
            state.pdfBytes = new Uint8Array(ev.target.result);
            try {
                state.pdfDoc = await pdfjsLib.getDocument({ data: state.pdfBytes }).promise;
                state.pageNum = 1;
                renderUI();
                await renderPage();
            } catch (err) { alert("Error loading PDF"); }
            els.loader.classList.add('hidden');
        };
        reader.readAsArrayBuffer(file);
    });

    function renderUI() {
        els.sidebar.classList.remove('hidden');
        els.empty.classList.add('hidden');
        els.container.classList.remove('hidden');
        els.pagination.classList.remove('hidden');
        document.getElementById('download-btn').disabled = false;
    }

    async function renderPage() {
        const page = await state.pdfDoc.getPage(state.pageNum);
        const viewport = page.getViewport({ scale: state.scale });
        els.canvas.height = viewport.height; els.canvas.width = viewport.width;
        els.container.style.width = viewport.width + "px"; els.container.style.height = viewport.height + "px";
        await page.render({ canvasContext: els.ctx, viewport }).promise;
        
        els.pageInfo.innerText = `Page ${state.pageNum} / ${state.pdfDoc.numPages}`;
        
        // Toggle Element Visibility based on page
        document.querySelectorAll('.drag-element').forEach(el => {
            el.style.display = (parseInt(el.dataset.page) === state.pageNum) ? 'block' : 'none';
        });
    }

    // --- 2. Interact JS (Drag & Resize) ---
    interact('.drag-element')
        .draggable({
            listeners: { move: (event) => {
                const target = event.target;
                const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                target.style.transform = `translate(${x}px, ${y}px)`;
                target.setAttribute('data-x', x); target.setAttribute('data-y', y);
                activateElement(target);
            }},
            modifiers: [ interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true }) ]
        })
        .resizable({
            edges: { left: true, right: true, bottom: true, top: true },
            listeners: { move: (event) => {
                const target = event.target;
                let x = (parseFloat(target.getAttribute('data-x')) || 0);
                let y = (parseFloat(target.getAttribute('data-y')) || 0);
                target.style.width = event.rect.width + 'px';
                target.style.height = event.rect.height + 'px';
                x += event.deltaRect.left; y += event.deltaRect.top;
                target.style.transform = `translate(${x}px, ${y}px)`;
                target.setAttribute('data-x', x); target.setAttribute('data-y', y);
                activateElement(target);
            }},
            modifiers: [ interact.modifiers.aspectRatio({ ratio: 'preserve' }), interact.modifiers.restrictEdges({ outer: 'parent' }) ]
        });

    function activateElement(el) {
        document.querySelectorAll('.drag-element').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
    }
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.drag-element') && !e.target.closest('.tool-btn') && !e.target.closest('.modal')) {
            document.querySelectorAll('.drag-element').forEach(el => el.classList.remove('active'));
        }
    });

    // --- 3. DOM Element Creation ---
    function addElementToDOM(type, content) {
        const div = document.createElement('div');
        div.className = 'drag-element';
        div.dataset.page = state.pageNum;
        
        // Initial Position (Centered-ish)
        const startX = 50, startY = 50;
        div.style.transform = `translate(${startX}px, ${startY}px)`;
        div.setAttribute('data-x', startX); div.setAttribute('data-y', startY);

        if(type === 'image') {
            div.style.width = '200px'; div.style.height = '100px';
            const img = document.createElement('img');
            img.src = content;
            img.className = 'w-full h-full object-contain pointer-events-none';
            div.appendChild(img);
        } else {
            div.style.minWidth = '100px'; div.className += ' p-2 border border-transparent hover:border-blue-300';
            const input = document.createElement('div');
            input.contentEditable = true; input.innerText = content;
            input.className = 'text-lg font-sans outline-none w-full h-full bg-transparent whitespace-nowrap';
            div.appendChild(input);
            input.onfocus = () => div.classList.remove('drag-element');
            input.onblur = () => div.classList.add('drag-element');
        }

        // Controls
        const handle = document.createElement('div'); handle.className = 'resize-handle handle-se';
        const delBtn = document.createElement('div'); delBtn.className = 'delete-btn';
        delBtn.innerHTML = '&times;'; delBtn.onclick = (e) => { e.stopPropagation(); div.remove(); };
        div.appendChild(handle); div.appendChild(delBtn);
        div.onmousedown = () => activateElement(div);
        
        els.container.appendChild(div);
        activateElement(div);
    }

    // --- 4. Modal Logic (Draw, Type, Upload) ---
    function openSignatureModal() {
        els.modal.classList.remove('hidden');
        setTimeout(() => { els.modal.classList.remove('opacity-0'); els.modalContent.classList.remove('scale-95'); }, 10);
        resizeCanvas(els.padCanvas);
        signaturePad = new SignaturePad(els.padCanvas, { minWidth: 1, maxWidth: 2.5 });
        switchTab('draw');
    }

    window.closeModal = () => {
        els.modalContent.classList.add('scale-95');
        els.modal.classList.add('opacity-0');
        setTimeout(() => els.modal.classList.add('hidden'), 200);
    }

    window.switchTab = (tab) => {
        activeTab = tab;
        const tabs = ['draw', 'type', 'upload'];
        tabs.forEach(t => {
            const btn = document.getElementById(`tab-${t}`);
            const area = document.getElementById(`area-${t}`);
            if(t === tab) {
                btn.className = "flex-1 py-1 text-sm font-medium rounded-md shadow bg-white text-blue-600 transition-all";
                area.classList.remove('hidden');
            } else {
                btn.className = "flex-1 py-1 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700 transition-all";
                area.classList.add('hidden');
            }
        });
    }

    window.clearPad = () => {
        if(activeTab === 'draw') signaturePad.clear();
        if(activeTab === 'type') { document.getElementById('type-input').value = ''; document.getElementById('type-preview').innerText = ''; }
        if(activeTab === 'upload') { 
            els.sigUpload.value = ''; 
            els.uploadPrev.classList.add('hidden'); 
            els.uploadPlace.classList.remove('hidden'); 
        }
    }

    document.getElementById('type-input').addEventListener('input', (e) => document.getElementById('type-preview').innerText = e.target.value);

    // Handle Upload Preview
    els.sigUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            els.uploadPrev.src = ev.target.result;
            els.uploadPrev.classList.remove('hidden');
            els.uploadPlace.classList.add('hidden');
        }
        reader.readAsDataURL(file);
    });

    window.applySignature = () => {
        let imgData;
        if(activeTab === 'draw') {
            if(signaturePad.isEmpty()) { alert("Please sign first"); return; }
            imgData = signaturePad.toDataURL();
        } else if(activeTab === 'type') {
            const text = document.getElementById('type-input').value;
            if(!text) { alert("Please type name"); return; }
            const tCan = document.createElement('canvas'); const ctx = tCan.getContext('2d');
            tCan.width = 600; tCan.height = 200;
            ctx.font = "italic 80px 'Brush Script MT', cursive"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(text, 300, 100);
            imgData = tCan.toDataURL();
        } else if(activeTab === 'upload') {
            if(els.uploadPrev.classList.contains('hidden')) { alert("Please upload an image"); return; }
            imgData = els.uploadPrev.src;
        }
        addElementToDOM('image', imgData);
        closeModal();
    }

    // --- 5. Tool Actions ---
    document.getElementById('stamp-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => addElementToDOM('image', ev.target.result);
            reader.readAsDataURL(file);
            e.target.value = '';
        }
    });

    window.addTextTool = () => addElementToDOM('text', 'Type Here');
    window.addDateTool = () => addElementToDOM('text', new Date().toLocaleDateString());

    // --- 6. Navigation ---
    document.getElementById('prev-page').onclick = () => { if (state.pageNum > 1) { state.pageNum--; renderPage(); } };
    document.getElementById('next-page').onclick = () => { if (state.pageNum < state.pdfDoc.numPages) { state.pageNum++; renderPage(); } };

    // --- 7. Download ---
    document.getElementById('download-btn').onclick = async () => {
        els.loader.classList.remove('hidden');
        try {
            const { PDFDocument, rgb } = PDFLib;
            const pdfDoc = await PDFDocument.load(state.pdfBytes);
            const pages = pdfDoc.getPages();

            for (const el of document.querySelectorAll('.drag-element')) {
                const pageIndex = parseInt(el.dataset.page) - 1;
                const pdfPage = pages[pageIndex];
                
                const rect = el.getBoundingClientRect();
                const containerRect = els.container.getBoundingClientRect();
                
                const pdfW = pdfPage.getWidth();
                const pdfH = pdfPage.getHeight();
                const scaleX = pdfW / els.canvas.width;
                const scaleY = pdfH / els.canvas.height;

                const finalX = (rect.left - containerRect.left) * scaleX;
                const finalY = pdfH - ((rect.top - containerRect.top + rect.height) * scaleY);
                const finalW = rect.width * scaleX;
                const finalH = rect.height * scaleY;

                if (el.querySelector('img')) {
                    const imgData = el.querySelector('img').src;
                    const embedImg = imgData.startsWith('data:image/png') ? await pdfDoc.embedPng(imgData) : await pdfDoc.embedJpg(imgData);
                    pdfPage.drawImage(embedImg, { x: finalX, y: finalY, width: finalW, height: finalH });
                } else {
                    const text = el.querySelector('div[contenteditable]').innerText;
                    const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                    pdfPage.drawText(text, { x: finalX, y: finalY + (finalH*0.2), size: finalH * 0.7, font, color: rgb(0,0,0) });
                }
            }

            const blob = new Blob([await pdfDoc.save()], { type: 'application/pdf' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'signed_document.pdf'; link.click();
        } catch(e) { console.error(e); alert("Save Error"); }
        els.loader.classList.add('hidden');
    };
</script>
</body>
</html>
